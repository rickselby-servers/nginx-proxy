stages:
  - redeploy
  - join-networks

include:
  - local: '.gitlab-ci-template.yml'

redeploy:
  extends: .docker-template
  stage: redeploy
  script:
    - eval $COMPOSE_COMMAND pull
    - eval $COMPOSE_COMMAND down --remove-orphans
    - eval $COMPOSE_COMMAND up -d
  only:
    refs:
      - master
    changes:
      - docker-compose.yml

join-networks:
  extends: .docker-template
  stage: join-networks
  before_script:
    - mkdir $DOCKER_CERT_PATH
    - export DOCKER_HOST=$REMOTE_DOCKER_HOST
    - echo "$CA" > $DOCKER_CERT_PATH/ca.pem
    - echo "$CLIENT_CERT" > $DOCKER_CERT_PATH/cert.pem
    - echo "$CLIENT_KEY" > $DOCKER_CERT_PATH/key.pem
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" "$CI_REGISTRY" --password-stdin
    - export COMPOSE_COMMAND="docker-compose -p $STACK_NAME"
    - apk add --no-cache bash
  script:
    - /bin/bash networks.sh
  only:
    - master

